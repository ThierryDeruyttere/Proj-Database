{% extends "codegalaxy.html" %}
{% load staticfiles %}
{% load i18n %}
{% load custom_filters %}

{% block page_css %}
  <link rel="stylesheet" href="{% static "css/answerQuestion.css" %}" />
{% endblock page_css %}

{% block base_body %}
  <div class="row">

    <div class="row">
      <div data-alert class="alert-box info radius question">
      </div>
    </div>

    <form id="answer_question" method="post" action="{{ exercise.exercise_number }}/submit">
      {% csrf_token %}

      {% if exercise.exercise_type == "Open Question" %}
        <div class="row" id="Open Question">
          <table class="answers">
            <caption id="caption">Select the right answer</caption>
            {% for i in answers %}
              <div class="row">
                <div class="large-6 large-offset-1 columns">
                  <tr>
                    {% if not list_owner %}
                      <td>{{ forloop.counter }}</td>
                      <td>{{ i }}</td>
                      <td>
                        {% if forloop.counter == current_answer  %}
                          <input type="radio" name="corr_answer" value="{{ forloop.counter }}" id="corr_answer_no_{{ forloop.counter }}" checked><label for="answer_no_{{ forloop.counter }}">{% trans "Correct answer" %}</label>
                        {% else %}
                          {% if forloop.counter == 1  %}
                            <input type="radio" name="corr_answer" value="{{ forloop.counter }}" id="corr_answer_no_{{ forloop.counter }}" checked><label for="answer_no_{{ forloop.counter }}">{% trans "Correct answer" %}</label>
                          {% else %}
                            <input type="radio" name="corr_answer" value="{{ forloop.counter }}" id="corr_answer_no_{{ forloop.counter }}" ><label for="answer_no_{{ forloop.counter }}">{% trans "Correct answer" %}</label>
                          {% endif %}
                        {% endif %}
                        </td>
                    {% else %}

                      <td>{{ forloop.counter }})</td>
                      <td>{{ i }}</td>
                      <td>
                        {% if forloop.counter == correct_answer %}
                          <i class="fi-checkbox"></i>
                        {% endif %}
                      </td>
                    {% endif %}
                  </tr>
                </div>
              </div>
            {% endfor %}
          </table>
        </div>

      {% else %}
        <div class="row" id="Code">
          {% if current_answer %}
            <textarea id="user_code" name="user_code">{{ current_answer }}</textarea>
          {% else %}
            <textarea id="user_code" name="user_code">{{ exercise.code }}</textarea>
          {% endif %}

          <div class="large-9 columns">
            <!-- <div class="row">
            To be used if we have turtle graphics
            <canvas id="mycanvas" class="code-output"></canvas> -->
          </div>
        </div>
        <div id="output_alert" class="alert-box alert radius" data-alert></div>

        <div class="row">
          {% if not solved %}
            <ul class="button-group radius">
              {% if logged_in %}
              <li><a id="get_hint" class="button radius small">{% trans "Get hint" %}</a></li>
              <li><a id="reset" class="alert button radius small">{% trans "Reset question" %}</a></li>
              {% endif %}
            </ul>
          {% endif %}
          <textarea id="used_hints" name="used_hints" hidden="True">0</textarea>
        </div>
        <div class="row">
          {% if not solved %}
            <div data-alert class="alert-box hints secondary">
              <ul>
                {% for hint in hints %}
                  <li id="hint{{ forloop.counter }}" hidden="True" ><label>{{ hint|safe }}</label></li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% if exercise.exercise_type != "Open Question" %}
        {% if list_owner %}
          <h3>{% trans "Answer" %}</h3>
          <textarea id="correct_answer" name="correct_answer">{{ correct_answer }}</textarea>
        {% endif %}
      {% endif %}


      <div class="row">
        <div class="text-center">
          {% if logged_in %}
            {% if list_owner %}
              <h3>{% trans "This question is part of your own list!" %}</h3>
            {% else %}
              {% if solved %}
                <h1>{% trans "You solved the question!" %}</h1>
              {% else %}
                {% if exercise.exercise_type == "Open Question" %}
                  <input id="submit_answer" type="submit" class="button tiny radius" value="{% trans "Answer" %}">
                {% else %}
                  <input id="code_output" name="code_output" type="hidden" value=""></input>
                  <input id="submit_answer_code" type="button" class="button tiny radius" value="{% trans "Answer" %}">
                {% endif %}
              {% endif %}
            {% endif %}
          {% endif %}
          <a href="/l/{{ exercise.exerciseList_id }}" class="button tiny radius">{% trans "Return to list" %}</a></li>
          {% if list_owner %}
            <a href="/l/{{ exercise.exerciseList_id }}/{{ exercise.id}}/{{ exercise.exercise_number }}/edit" class="button tiny radius">{% trans "Edit Question" %}</a>
          {% endif %}
        </div>
      </div>
    </form>
  </div>

{% endblock base_body %}

{% block body_js %}
  <script type="text/javascript">

    {% if exercise.exercise_type != "Open Question" %}
      var code_text = CodeMirror.fromTextArea(user_code,
              {
                {% if list_owner %}
                  readOnly: true,
                {% endif %}
                {% if not logged_in %}
                  readOnly: true,
                {% endif %}
                lineNumbers: true,
                {% if list.programming_language_string == "Python" %}
                  mode: "python",
                {% elif list.programming_language_string == "C++" %}
                  mode: "text/x-c++src",
                {% elif list.programming_language_string == "SQL" %}
                  mode: "sql",
                {% endif %}
                theme: "monokai"
              });
      {% if list_owner %}
        var correct_answer_code = CodeMirror.fromTextArea(correct_answer,
                {
                  lineNumbers: true,
                  readOnly: true,
                  {% if list.programming_language_string == "Python" %}
                    mode: "python",
                  {% elif list.programming_language_string == "C++" %}
                    mode: "text/x-c++src",
                  {% elif list.programming_language_string == "SQL" %}
                    mode: "sql",
                  {% endif %}
                  theme: "monokai"
                });
      {% endif %}
    {% endif %}

    var curr_hint = 1;

    $(document).ready(function(){
      var str = "{%  multi_line exercise.question %}";
      var html = $.parseHTML(str);
      $('.question').append(html);

      $(".hints").hide();
      checkAvailable();

      {% if list_owner %}
        for(i = 0; i < {{ hints|length }}; i++){
          addHint();
        }
      {% else %}
        for(i = 0; i < {{ last_hint_used }}; i++){
          addHint();
        }
      {% endif %}
    });

    function checkAvailable() {
      if(curr_hint >= {{ hints|length }}) {
        $('#get_hint').addClass('disabled');
      }
    }

    function addHint() {
      if(curr_hint == 1) {
        $(".hints").show();
      }
      $('#hint'+curr_hint).show();
      $("#used_hints").val((curr_hint).toString());
      checkAvailable();
      ++curr_hint;
    }

    $("#get_hint").click(function(){
      if(!$("#get_hint").hasClass("disabled")) {
        addHint();
      }
    });

    $("#output_alert").hide();
    {% if not list_owner %}
      $("#get_hint").click(function() {
        if(!$("#get_hint").hasClass("disabled")) {
          var post_data = {
            list_id: {{ list_id }},
            ex_number: {{exercise.exercise_number}},
            amount_of_hints: {{ hints|length }},
            max_score: {{ exercise.max_score }},
            penalty: {{ penalty }}
          }
          $.ajax({
            type: "POST",
            url: "/addHint/",
            data: post_data,
            dataType: "text",

            success: function (response) {
              // nothing needs to happen on the site
            },
            error: function (jqXHR, textStatus, error) {
              $("#output_alert").html(jqXHR.responseText.toString());
              $("#output_alert").show();
            }
          });
        }
      });
    {% endif %}

    $("#submit_answer_code").click(function()
    {
      var post_data = { code : code_text.getValue() };
      $.ajax({
        type: "POST",
        url: "/eval/{{ exercise.programming_language }}/".toLowerCase(),
        data: post_data,
        dataType: "text",

        success: function(response) {
          $("#code_output").val(response);
          $("#answer_question").submit();
        },
        error: function(jqXHR, textStatus, error) {
          $("#output_alert").html(jqXHR.responseText.toString());
          $("#output_alert").show();
        }
      });
    });

    {% if exercise.exercise_type == "Code" %}
      $('#reset').click(function(){
        code_text.getDoc().setValue($("#user_code").val());
      });
    {% endif %}


  </script>


{% endblock body_js %}
