{% extends "codegalaxy.html" %}
{% load staticfiles %}
{% load i18n %}
{% load custom_filters %}

{% block page_css %}
  <link rel="stylesheet" href="{% static "css/answerQuestion.css" %}" />
{% endblock page_css %}

{% block base_body %}
  <div class="row">

    <div class="row">
      <div data-alert class="alert-box info radius question">
      </div>
    </div>

    <form id="answer_question" method="post" action="{{ exercise.exercise_number }}/submit">
      {% csrf_token %}

      {% if exercise.exercise_type == "Open Question" %}
        {% include "partial/answer_open.html" %}
      {% else %}
        {% include "partial/answer_code.html" %}
      {% endif %}

      {% if exercise.exercise_type != "Open Question" %}
        {% if list_owner %}
          <h3>{% trans "Answer" %}</h3>
          <textarea id="correct_answer" name="correct_answer">{{ correct_answer }}</textarea>
        {% endif %}
      {% endif %}


      <div class="row">
        <div class="text-center">
          {% if logged_in %}
            {% if list_owner %}
              <h3>{% trans "This question is part of your own list!" %}</h3>
            {% else %}
              {% if solved %}
                <h2>{% trans "You solved the question!" %}</h2>
              {% else %}
                {% if exercise.exercise_type == "Open Question" %}
                  <input id="submit_answer" type="submit" class="button tiny radius" value="{% trans "Answer" %}">
                {% else %}
                  <input id="code_output" name="code_output" type="hidden" value=""></input>
                  <input id="submit_answer_code" type="button" class="button tiny radius" value="{% trans "Answer" %}">
                {% endif %}
              {% endif %}
            {% endif %}
          {% endif %}
          <a href="/l/{{ exercise.exerciseList_id }}" class="button tiny radius">{% trans "Return to list" %}</a></li>
          {% if list_owner %}
            <a href="/l/{{ exercise.exerciseList_id }}/{{ exercise.id}}/{{ exercise.exercise_number }}/edit" class="button tiny radius">{% trans "Edit Question" %}</a>
          {% endif %}
        </div>
      </div>
    </form>
  </div>

{% endblock base_body %}

{% block body_js %}
  <script type="text/javascript">

    {% if exercise.exercise_type != "Open Question" %}
      var code_text = CodeMirror.fromTextArea(user_code,
              {
                {% if list_owner %}
                  readOnly: true,
                {% endif %}
                {% if not logged_in %}
                  readOnly: true,
                {% endif %}
                lineNumbers: true,
                {% if list.programming_language_string == "Python" %}
                  mode: "python",
                {% elif list.programming_language_string == "C++" %}
                  mode: "text/x-c++src",
                {% elif list.programming_language_string == "SQL" %}
                  mode: "sql",
                {% endif %}
                theme: "monokai"
              });
      {% if list_owner %}
        var correct_answer_code = CodeMirror.fromTextArea(correct_answer,
                {
                  lineNumbers: true,
                  readOnly: true,
                  {% if list.programming_language_string == "Python" %}
                    mode: "python",
                  {% elif list.programming_language_string == "C++" %}
                    mode: "text/x-c++src",
                  {% elif list.programming_language_string == "SQL" %}
                    mode: "sql",
                  {% endif %}
                  theme: "monokai"
                });
      {% endif %}
    {% endif %}

    var curr_hint = 1;

    $(document).ready(function(){
      var str = "{%  multi_line exercise.question %}";
      var html = $.parseHTML(str);
      $('.question').append(html);

      $(".hints").hide();
      checkAvailable();

      {% if list_owner %}
        for(i = 0; i < {{ hints|length }}; i++){
          addHint();
        }
      {% else %}
        for(i = 0; i < {{ last_hint_used }}; i++){
          addHint();
        }
      {% endif %}
    });

    function checkAvailable() {
      if(curr_hint >= {{ hints|length }}) {
        $('#get_hint').addClass('disabled');
      }
    }

    function addHint() {
      if(curr_hint == 1) {
        $(".hints").show();
      }
      $('#hint'+curr_hint).show();
      $("#used_hints").val((curr_hint).toString());
      checkAvailable();
      ++curr_hint;
    }

    $("#get_hint").click(function(){
      if(!$("#get_hint").hasClass("disabled")) {
        addHint();
      }
    });

    $("#output_alert").hide();
    {% if not list_owner %}
      $("#get_hint").click(function() {
        if(!$("#get_hint").hasClass("disabled")) {
          var post_data = {
            list_id: {{ list_id }},
            ex_number: {{exercise.exercise_number}},
            amount_of_hints: {{ hints|length }},
            max_score: {{ exercise.max_score }},
            penalty: {{ penalty }}
          }
          $.ajax({
            type: "POST",
            url: "/addHint/",
            data: post_data,
            dataType: "text",

            success: function (response) {
              // nothing needs to happen on the site
            },
            error: function (jqXHR, textStatus, error) {
              $("#output_alert").html(jqXHR.responseText.toString());
              $("#output_alert").show();
            }
          });
        }
      });
    {% endif %}

    $("#submit_answer_code").click(function()
    {
      var post_data = { code : code_text.getValue() };
      $.ajax({
        type: "POST",
        url: "/eval/{{ exercise.programming_language }}/".toLowerCase(),
        data: post_data,
        dataType: "text",

        success: function(response) {
          $("#code_output").val(response);
          $("#answer_question").submit();
        },
        error: function(jqXHR, textStatus, error) {
          $("#output_alert").html(jqXHR.responseText.toString());
          $("#output_alert").show();
        }
      });
    });

    {% if exercise.exercise_type == "Code" %}
      $('#reset').click(function(){
        code_text.getDoc().setValue($("#user_code").val());
      });
    {% endif %}


  </script>


{% endblock body_js %}
