{% extends "codegalaxy.html" %}

{% load staticfiles %}

{% block head_js %}
  <script src="{% static "Chart.min.js" %}"></script>
{% endblock head_js %}

{% block base_body  %}
  <head>
    <link rel="stylesheet" type="text/css" href="{% static "css/listOverview.css" %}" />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  </head>

  <div class="row">

  <div class="large-8 columns">
  <div class="panel">
    <div class="row">
      <div class="large-12 columns">
        <fieldset>
          <legend>Search exercise lists</legend>
          <form method="POST" id="search_options">
            {% csrf_token %}
            <div class="row" id="search">
              <div class="row">
                <div class="large-6 columns">
                  <div class="row collapse prefix-radius">
                    <div class="small-2 columns">
                      <span class="prefix"><img src="{% static "media/planet.png" %}"></span>
                    </div>
                    <div class="small-10 columns">
                      <input placeholder="Planet name" type="text" name="title">
                    </div>
                  </div>
                </div>
                <div class="large-6 columns">
                  <div class="row collapse prefix-radius">
                    <div class="small-2 columns">
                      <span class="prefix" id="user_image"><div id="astronaut"></div></span>
                    </div>
                    <div class="small-10 columns">
                      <input placeholder="Astronaut name" type="text" name="user">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="large-4 columns">
                Solar system
                <select name="prog_lang">
                  <option value="" selected></option>
                  {% for lang in languages %}
                    <option value="{{ lang.name }}">{{ lang.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="large-6 columns">
                Separate subjects by comma
                <div class="row collapse prefix-radius">
                  <div class="small-4 columns">
                    <span class="prefix">Subjects</span>
                  </div>
                  <div class="small-8 columns">
                    <input type="text" id="subjects" name="subjects" class="text-center">
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="large-6 columns large-centered">
                <label id="amount"></label>
                <div id="slider-range"></div>
              </div>
            </div>

            <input type="hidden" id="min_difficulty" name="min_difficulty" readonly="True" class="text-center" value="1">
            <input type="hidden" id="max_difficulty" name="max_difficulty" readonly="True" class="text-center" value="5">

            <div class="row">
              <br>
              <div class="large-4 columns">
                <button class="small round button" id="search_button">Search</button>
              </div>
              <div class="large-4 end columns">
                <select id="order_mode" name="order_mode">
                  <option>Ascending</option>
                  <option>Descending</option>
                </select>
              </div>
            </div>
          </form>
        </fieldset>
      </div>
    </div>
  </div>
  <div class="row" id="galaxy-navigation">
    <div class="planets">
      {% for list in all_lists %}
        <div>
        {% if list.prog_lang_id == 1 %}
          <div class="planet python">
        {% elif list.prog_lang_id == 2%}
          <div class="planet cpp">
        {% elif list.prog_lang_id == 3 %}
          <div class="planet sql">
        {% endif %}
      {{ forloop.counter }}
      </div>
      <div class="information panel">
        <div class="row">
          <div class="text-center">
            {{ list.name }}
          </div>
        </div>
        <div class="row">
          <div class="text-center">
            <a class="radius tiny button" type="button" href="/l/{{ list.id }}">Explore!</a>
          </div>
        </div>
      </div>
      </div>
      {% endfor %}
      </div>
      </div>
    </div>

    <div class="large-4 columns">
      <div class="text-center">
        <a id="create" href="/l/create" class="round alert button">Create new list</a>
      </div>
      <hr>
      <div class="panel">
        <legend># Planets/Programming Language</legend>
        {{ lists_per_prog_lang_graph | safe }}
      </div>
      <div class="panel">
        <legend>Most Popular Subjects</legend>
        {{ most_popular_subjects | safe }}
      </div>
      <div class="panel">
        <legend>Users who made the most lists</legend>
        {{ users_with_mosts_made_lists | safe }}
      </div>
    </div>
  </div>
{% endblock %}

{% block body_js %}
  <script>

    $('.planets').on('afterChange',function(event, slick, currentSlide, nextSlide){
      var panel = $(this).find('.slick-center').find('.information')[0];
      $(panel).slideUp(0);
      $(panel).css('visibility','visible');
      $(panel).slideDown();
    });

    $('.planets').on('beforeChange',function(event, slick, currentSlide, nextSlide){
      var panel = $(this).find('.slick-center').find('.information')[0];
      $(panel).css('visibility','hidden');
      $(panel).slideUp(0);
    });


    function createSlick(slides){
      slides = slides || 5;
      $('.planets').slick({
        infinite: false,
        centerMode: true,
        slidesToShow: slides,
        centerPadding: '0px',
        focusOnSelect: true,
        slideGlide: true,
        //Pure for other screensizes
        responsive: [
          {
            breakpoint: 768,
            settings: {
              arrows: false,
              centerMode: true,
              centerPadding: '40px',
              slidesToShow: 3
            }
          },
          {
            breakpoint: 480,
            settings: {
              arrows: false,
              centerMode: true,
              centerPadding: '40px',
              slidesToShow: 1
            }
          }]
      });

      var panel = $('.planets').find('.slick-center').find('.information')[0];
      planetWidth = $('.planets').find('.slick-center').width() * 1.5;
      $(panel).css('visibility','visible');
      $(panel).slideDown();

    }

    $(document).ready(function(){
      createSlick();
      $("#amount").text("planet difficulty min-max: 1 - 5");
    });

    $("#search_button").click(function()
    {
      $(function(){
        $('#search_options').submit(function(e){
          e.preventDefault();
          var form = $(this);
          var post_data = form.serialize();
          $.ajax({
            type: 'POST',
            url: "",
            data: post_data,
            dataType: "text",

            success: function(response) {
              //unslick() doesn't seem to work, then we just do it this way.
              $('.planets').slick('unslick');
              $('.planets').empty();
              $('.planets').append(response);
              var slides = 5;
              //temporary fix
              //TODO FIX ME
              var track_am = $(response).find('.information').length;
              if(track_am < 5){
                slides = track_am;
              }
              createSlick(slides);

            }
          });
        });
      });
    });

    $("#slider-range").slider({
      range: true,
      min: 1,
      max: 5,
      values: [1, 5],
      slide: function( event, ui ){
        var val_0 = ui.values[0];
        var val_1 = ui.values[1];
        $("#max_difficulty").val(val_1);
        $("#min_difficulty").val(val_0);
        $("#amount").text("planet difficulty min-max: "+val_0 + " - " + val_1);

      }
    });


  </script>
{% endblock %}
