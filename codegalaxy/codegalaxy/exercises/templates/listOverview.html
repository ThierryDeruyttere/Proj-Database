{% extends "codegalaxy.html" %}
{% load staticfiles %}
{% load custom_filters %}

{% block head_js %}
  <script src="{% static "Chart.min.js" %}"></script>
{% endblock head_js %}

{% block page_css %}
  <link rel="stylesheet" type="text/css" href="{% static "css/listOverview.css" %}" />
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
{% endblock page_css %}


{% block base_body  %}
  <div class="row">

  <div class="large-8 columns">
    <div class="row">
      <div class="large-12 columns">
        <h1>Search exercise lists</h1>
        <div class="panel">
          <form method="POST" id="search_options">
            {% csrf_token %}
            <div class="row" id="search">
              <div class="row">
                <div class="large-6 columns">
                  <div class="row collapse prefix-radius">
                    <div class="small-2 columns">
                      <span class="prefix"><img src="{% static "media/icons/planet.png" %}"></span>
                    </div>
                    <div class="small-10 columns">
                      <input placeholder="Planet name" type="text" name="title">
                    </div>
                  </div>
                </div>
                <div class="large-6 columns">
                  <div class="row collapse prefix-radius">
                    <div class="small-2 columns">
                      <span class="prefix" id="user_image"><div id="astronaut"></div></span>
                    </div>
                    <div class="small-10 columns">
                      <input placeholder="Astronaut name" type="text" name="user">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="large-4 columns">
                Solar system
                <select name="prog_lang">
                  <option value="" selected></option>
                  {% for lang in languages %}
                    <option value="{{ lang.name }}">{{ lang.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="large-6 columns">
                Subjects - separate by comma
                <div class="row collapse prefix-radius">
                  <div class="small-12 columns">
                    <input type="text" id="subjects" name="subjects" class="text-center">
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="large-6 columns large-centered">
                <label id="amount"></label>
                <div id="slider-range"></div>
              </div>
            </div>

            <input type="hidden" id="min_difficulty" name="min_difficulty" readonly="True" class="text-center" value="1">
            <input type="hidden" id="max_difficulty" name="max_difficulty" readonly="True" class="text-center" value="5">

            <div class="row">
              <br>
              <div class="large-4 columns large-centered">
                <select id="order_mode" name="order_mode">
                  <option>Ascending</option>
                  <option>Descending</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="large-2 columns large-centered">
                <button class="small round button" id="search_button">Search</button>
              </div>
            </div>
          </form>
      </div>
      </div>
    </div>

  <div class="row" id="galaxy-navigation">

    <div class="planets">
      {% for list in all_lists|copy_list %}
        <div>
        {% if list.programming_language.id == 1 %}
          <div class="planet python">
        {% elif list.programming_language.id == 2 %}
          <div class="planet cpp">
        {% elif list.programming_language.id == 3 %}
          <div class="planet sql">
        {% endif %}
      {{ forloop.counter }}
      </div>

      </div>
      {% endfor %}
      </div>

      <div class="row informations">
        {% for list in all_lists|copy_list %}
          <div class="information panel" id="info{{ forloop.counter }}" hidden="True">
            <div class="row">
              <div class="text-center">
                {{ list.name }}
              </div>
            </div>
            <div class="row">
              <div class="text-center">
                <a class="radius tiny button" type="button" href="/l/{{ list.id }}">Explore!</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>


      </div>
    </div>

    <div class="large-4 columns">
      <div class="text-center">
        <a id="create" href="/l/create" class="round alert button">Create new list</a>
      </div>
      <hr>
      <div class="panel">
        <legend># Planets/Programming Language</legend>
        {{ lists_per_prog_lang_graph | safe }}
      </div>
      <div class="panel">
        <legend>Most Popular Subjects</legend>
        {{ most_popular_subjects | safe }}
      </div>
      <div class="panel">
        <legend>Users who made the most lists</legend>
        {{ users_with_mosts_made_lists | safe }}
      </div>
    </div>
  </div>
{% endblock %}

{% block body_js %}
  <script>

    $('.planets').on('afterChange',function(event, slick, currentSlide, nextSlide){
      var id = $($('.planets').find('.slick-center')).find('.planet').text();
      var panel = $('#info'+ $.trim(id));
      $(panel).slideUp(0);
      $(panel).slideDown();
    });

    $('.planets').on('beforeChange',function(event, slick, currentSlide, nextSlide){
      var id = $($('.planets').find('.slick-center')).find('.planet').text();
      var panel = $('#info'+ $.trim(id));
      $(panel).slideUp(0);

    });


    function createSlick(slides){
      slides = slides || 5;
      $('.planets').slick({
        infinite: false,
        centerMode: true,
        slidesToShow: slides,
        centerPadding: '0px',
        focusOnSelect: true,
        slideGlide: true,
        //Pure for other screensizes
        responsive: [
          {
            breakpoint: 768,
            settings: {
              arrows: false,
              centerMode: true,
              centerPadding: '40px',
              slidesToShow: 3
            }
          },
          {
            breakpoint: 480,
            settings: {
              arrows: false,
              centerMode: true,
              centerPadding: '40px',
              slidesToShow: 1
            }
          }]
      });

      var id = $($('.planets').find('.slick-center')).find('.planet').text();
      $('#info'+ $.trim(id)).show();

    }

    $(document).ready(function(){
      createSlick();
      $("#amount").text("planet difficulty min-max: 1 - 5");
    });

    $("#search_button").click(function()
    {
      $(function(){
        $('#search_options').submit(function(e){
          e.preventDefault();
          var form = $(this);
          var post_data = form.serialize();
          $.ajax({
            type: 'POST',
            url: "",
            data: post_data,
            dataType: "json",

            success: function(response) {
              //unslick() doesn't seem to work, then we just do it this way.
              $('.planets').slick('unslick');
              $('.planets').empty();
              $('.informations').empty();

              $('.planets').append(response["planets"]);
              $('.informations').append(response['info']);
              var slides = 5;
              //temporary fix
              //TODO FIX ME
              var track_am = $(response['planets']).find('.planet').length;
              if(track_am < 5){
                slides = 1;
              }
              createSlick(slides);

            }
          });
        });
      });
    });

    $("#slider-range").slider({
      range: true,
      min: 1,
      max: 5,
      values: [1, 5],
      slide: function( event, ui ){
        var val_0 = ui.values[0];
        var val_1 = ui.values[1];
        $("#max_difficulty").val(val_1);
        $("#min_difficulty").val(val_0);
        $("#amount").text("planet difficulty min-max: "+val_0 + " - " + val_1);

      }
    });


  </script>
{% endblock %}
