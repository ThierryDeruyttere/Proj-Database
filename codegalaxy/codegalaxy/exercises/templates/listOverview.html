{% extends "codegalaxy.html" %}

{% load staticfiles %}

{% block head_js %}
  <script src="{% static "Chart.min.js" %}"></script>
{% endblock head_js %}

{% block base_body  %}

  <div class="row">

  <div class="large-4 columns">
    <div class="panel">
      <legend># Planets/Programming Language</legend>
      {{ lists_per_prog_lang_graph | safe }}
    </div>
    <div class="panel">
      <legend>Most Popular Subjects</legend>
      {{ most_popular_subjects | safe }}
    </div>
    <div class="panel">
      <legend>Users who made the most lists</legend>
      {{ users_with_mosts_made_lists | safe }}
    </div>
  </div>

  <div class="large-8 columns">
  <div class="panel">
    <div class="row">
      <fieldset>
        <legend>Search</legend>
        <form method="POST" id="search_options">
          {% csrf_token %}
          <div class="row" id="search">
            <div class="large-4 columns">
              <div class="row collapse prefix-radius">
                <div class="small-12 columns">
                  <input placeholder="Planet name" type="text" id="title" name="title" class="text-center" />
                </div>
              </div>
            </div>
            <div class="large-4 columns">
              <div class="row collapse prefix-radius">
                <div class="small-12 columns">
                  <input placeholder="name" type="text" id="user" name="user" class="text-center">
                </div>
              </div>
            </div>
            <div class="large-4 columns">
              <select id="order_mode" name="order_mode">
                <option>Ascending</option>
                <option>Descending</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="large-4 columns">
              <label>Solar system</label>
              <select name="prog_lang">
                <option value="" selected></option>
                {% for lang in languages %}
                  <option value="{{ lang.name }}">{{ lang.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="large-4 columns">
              <label>Separate subjects by comma</label>
              <div class="row collapse prefix-radius">
                <div class="small-4 columns">
                  <span class="prefix">Subjects</span>
                </div>
                <div class="small-8 columns">
                  <input type="text" id="subjects" name="subjects" class="text-center">
                </div>
              </div>
            </div>
          </div>

          <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
          <div class="row">
            <div id="slider-range"></div>
          </div>
          <div class="row">
            <div class="large-4 columns">
              <div class="row collapse prefix-radius">
                <div class="small-6 columns">
                  <span class="prefix">Min difficulty</span>
                </div>
                <div class="small-6 columns">
                  <input type="text" id="min_difficulty" name="min_difficulty" readonly="True" class="text-center" value="1">
                </div>
              </div>
            </div>
            <div class="large-4 columns">
              <div class="row collapse prefix-radius">
                <div class="small-6 columns">
                  <span class="prefix">Max difficulty</span>
                </div>
                <div class="small-6 columns">
                  <input type="text" id="max_difficulty" name="max_difficulty" readonly="True" class="text-center" value="5">
                </div>
              </div>
            </div>
          </div>
          <button class="small round button" id="search_button">Search</button>
        </form>
      </fieldset>
    </div>
  </div>
  <div class="row" id="galaxy-navigation">
    <div class="planets">
      {% for list in all_lists %}
        <div>
        {% if list.prog_lang_id == 1 %}
          <div class="planet python">
        {% elif list.prog_lang_id == 2%}
          <div class="planet cpp">
        {% elif list.prog_lang_id == 3 %}
          <div class="planet sql">
        {% endif %}
      {{ forloop.counter }}
      </div>
      <div class="information panel">
        <div class="row">
          <div class="text-center">
            {{ list.name }}
          </div>
        </div>
        <div class="row">
          <div class="text-center">
            <button class="tiny radius">Explore!</button>
          </div>
        </div>
      </div>
      </div>
      {% endfor %}
      </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block body_js %}
  <script>
  
    $('.planets').on('afterChange',function(event, slick, currentSlide, nextSlide){
      var panel = $(this).find('.slick-center').find('.information')[0];
      $(panel).slideUp(0);
      $(panel).css('visibility','visible');
      $(panel).slideDown();
    });

    $('.planets').on('beforeChange',function(event, slick, currentSlide, nextSlide){
      var panel = $(this).find('.slick-center').find('.information')[0];
      $(panel).css('visibility','hidden');
      $(panel).slideUp(0);
    });

    function createSlick(slides){
      slides = slides || 5;
      $('.planets').slick({
        infinite: false,
        centerMode: true,
        slidesToShow: slides,
        centerPadding: '0px',
        focusOnSelect: true,
        //Pure for other screensizes
        responsive: [
          {
            breakpoint: 768,
            settings: {
              arrows: false,
              centerMode: true,
              centerPadding: '40px',
              slidesToShow: 3
            }
          },
          {
            breakpoint: 480,
            settings: {
              arrows: false,
              centerMode: true,
              centerPadding: '40px',
              slidesToShow: 1
            }
          }]
      });

      var panel = $('.planets').find('.slick-center').find('.information')[0];
      $(panel).css('visibility','visible');
      $(panel).slideDown();
    }

    $(document).ready(function(){
      createSlick();
    });

    $("#search_button").click(function()
    {
      $(function(){
        $('#search_options').submit(function(e){
          e.preventDefault();
          var form = $(this);
          var post_data = form.serialize();
          $.ajax({
            type: 'POST',
            url: "",
            data: post_data,
            dataType: "text",

            success: function(response) {
              //unslick() doesn't seem to work, then we just do it this way.
              $('.planets').slick('unslick');
              $('.planets').empty();
              $('.planets').append(response);
              var slides = 5;
              //temporary fix
              //TODO FIX ME
              var track_am = $(response).find('.information').length;
              if(track_am < 5){
                slides = track_am;
              }
              createSlick(slides);

            }
          });
        });
      });
    });

    $("#slider-range").slider({
      range: true,
      min: 1,
      max: 5,
      values: [1, 5],
      slide: function( event, ui ){
        $("#max_difficulty").val(ui.values[1]);
        $("#min_difficulty").val(ui.values[0]);
      }
    });
  </script>
{% endblock %}
