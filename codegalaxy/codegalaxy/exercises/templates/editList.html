{% extends "codegalaxy.html" %}
{% load staticfiles %}
{% load i18n %}

{% block page_css %}
  <link rel="stylesheet" href="{% static "css/editList.css" %}" />
{% endblock page_css %}

{% block base_body %}
  <div class="row">
    <form id="list_editor" method="POST">
      {% csrf_token %}
      <div class="panel callout radius info editList">
        <div class="row">
          <div class="large-12 large-text-center columns">

            <h2>{% trans "List editor" %}</h2>
          </div>
        </div>
        <div class="row">
          <div class="row">
            <div class="large-4 large-centered columns">
              <div class="row collapse prefix-radius">
                <div class="small-3 columns">
                  <span class="prefix">{% trans "List name" %}</span>
                </div>
                <div class="small-9 columns">
                  <input type="text" id="list_name" name="updated_list_name" class="text-center" value="{{ list.name }}">
                </div>
              </div>
            </div>
          </div>

          <div class="large-4 large-centered columns">

            <textarea placeholder="{% trans "Enter description of exercise list"  %}" name="updated_description_text">{{ list.description }}</textarea>

            <div class="row">
              <div class="small-10 medium-11 columns">
                <div class="range-slider round" id="slider" data-slider data-options="display_selector: #difficulty; start: 1; end: 5;">
                  <span class="range-slider-handle" role="slider" tabindex="0"></span>
                  <span class="range-slider-active-segment"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="large-4 large-centered columns">
              <div class="row collapse prefix-radius">
                <div class="small-3 columns">
                  <span class="prefix">{% trans "Difficulty" %}</span>
                </div>
                <div class="small-9 columns">
                  <input type="text" id="difficulty" name="updated_difficulty" readonly="True" class="text-center">
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="large-4 large-centered columns">
              <label>{% trans "Programming language" %}</label>
              <select name="prog_lang">
                {% for lang in programming_languages %}
                  {% if lang.name == current_prog_lang %}
                    <option value="{{ lang.name }}" selected>{{ lang.name }}</option>
                  {% else %}
                    <option value="{{ lang.name }}">{{ lang.name }}</option>
                  {% endif %}

                {% endfor %}
              </select>
            </div>
          </div>

          <div class="large-4 large-centered columns">
            <fieldset>
              <legend>{% trans "Subjects" %}</legend>
              <div class="row" id="subjects_list">
                {% for subject in subjects %}
                  <span class="success label" id="{{ subject }}" onclick="javascript:removeSubject(this)">{{ subject }}</span>
                  <input type="hidden" id="{{ subject }}_text" name="subject{{ forloop.counter0 }}" hidden="True" class="text-center" value="{{ subject }}">
                {% endfor %}
              </div>
            </fieldset>
            <h6>{% trans "click on a subject to delete it" %}</h6>
            <div class="row collapse prefix-radius">
              <div class="small-4 columns">
                <span class="prefix">{% trans "New subject" %}</span>
              </div>
              <div class="small-6 columns">
                <input type="text" id="subject" name="subject" class="text-center">

              </div>
              <div class="small-2  columns">
                <span class="postfix" id="add-subject"><i class="fi-plus"></i></span>
              </div>
            </div>
          </div>


          <div class ="row">
            <div class="large-10 large-centered columns">
              <ul class="pricing-table">
                <li class="title">{% trans "Exercises" %}</li>
                <div class="row">
                  <ul class="accordion dragdrop" id="dragdrop" data-accordion>
                    {% for exercise in all_exercises %}
                      <li class="accordion-navigation" id="exercise{{ exercise.exercise_number }}">
                        <a href="#Exerc{{ exercise.exercise_number }}"> {{ exercise.title }}</a>
                        <div id="Exerc{{ exercise.exercise_number }}" class="content">
                          <div class="row">
                            <a href="../{{ exercise.id}}/{{ exercise.exercise_number }}/edit" class="button tiny radius">{% trans "Edit exercise" %}</a>
                            <input type="button" class="tiny radius button removal" id="remove_{{ exercise.exercise_number }}" value="remove">
                          </div>
                          {% if exercise.isReference %}
                            <a href="/l/{{exercise.isReferenceTo.0}}">Original</a>[{{exercise.isReferenceTo.1}}]
                          {% endif %}
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                  <li class="price"></li>
                </div>
              </ul>
            </div>
            <input type="hidden" id="order" name="order">

          </div>
          <div class="row">
            <div class="large-text-center large-12 columns">
              <button id="sub_button" class="secondary button radius" value="Edit">{% trans "Edit" %}</button>
              <a href=".." class="secondary button radius">{% trans "Return to list" %}</a>
            </div>
          </div>
          <input type="hidden" id="current_subjects" name="current_subjects" value="{{ subjects|length }}">
        </div>
        <div class="row">

        </div>
      </div>
    </form>
  </div>
{% endblock base_body %}

{% block body_js %}
  <script>
    var subjects = {{ subjects|length }};
    $("#add-subject").click(function(){

      var label = document.createElement("span");
      label.setAttribute("class", "success label");
      label.innerHTML = document.getElementById("subject").value;
      label.setAttribute("id", "subject"+subjects);
      label.onclick = function(){
        $( '#' + label.id ).fadeOut( "slow", function() {
          // Animation complete.
          var elem = document.getElementById(label.id);
          elem.parentNode.removeChild(elem);
          var text = document.getElementById(label.id +"_text");
          text.parentNode.removeChild(text);
        });
      };

      var input = document.createElement("input");
      input.setAttribute('type', "hidden");
      input.setAttribute("class", "text-center");
      input.setAttribute("hidden", "True");
      input.setAttribute("id", "subject"+subjects+"_text");
      input.value = document.getElementById("subject").value;
      input.setAttribute("name", "subject"+subjects);
      document.getElementById("subject").value = "";
      subjects++;

      document.getElementById("current_subjects").value = subjects;
      document.getElementById("subjects_list").appendChild(label);
      document.getElementById("subjects_list").appendChild(input);
      //$(document).foundation();
      //$(document).foundation('span', 'reflow');

    });


    function removeSubject(obj){

      $( '#' + obj.id ).fadeOut( "slow", function() {
        // Animation complete.
        obj.parentNode.removeChild(obj);
        var text = document.getElementById(obj.id + "_text" );
        text.parentNode.removeChild(text);

      });
    }

    var updateFunc = function (event,ui){
      var t = $(this).sortable("toArray").toString();
      $("#order").val(t);
    };

    $(function() {
      $( "#dragdrop" ).sortable({
        delay:100,
        update: updateFunc
      });
      $( "#dragdrop" ).disableSelection();
      $( "#dragdrop").on("callUpdate", updateFunc);
    });


    $(".removal").click(function(){
      var text = this.id;
      text = text.replace('remove_', '');
      var remove = $("#exercise" + text);
      $(remove).remove();
      $( "#dragdrop").trigger("callUpdate");
    });

    $("#sub_button").click(function(){
      $(function(){
        $('#list_editor').submit(function(e){
          e.preventDefault();
          var form = $(this);
          var post_data = form.serialize();
          console.log(post_data);
          $.ajax({
            type: 'POST',
            url: "",
            data: post_data,

            success: function(response) {
              location.reload();
            }
          });
        });
      });
    });


    //Init document
    $(document).ready(function(){
      $('#slider').foundation('slider','set_value',{{ list.difficulty }});
      var t = $('#dragdrop').sortable("toArray").toString();
      $("#order").val(t);
    });

  </script>
{% endblock body_js %}
