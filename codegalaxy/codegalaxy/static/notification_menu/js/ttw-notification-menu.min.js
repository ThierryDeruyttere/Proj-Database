 /*
 * Created by 23rd and Walnut for Codebasehero.com
 * www.23andwalnut.com
 * www.codebasehero.com
 * User: Saleem El-Amin
 * Date: 7/27/11
 * Time: 6:41 AM
 *
 * Version: 1.00
 * License: You are free to use this file in personal and commercial products, however re-distribution 'as-is' without prior consent is prohibited.
 */
(function(a){a.ttwNotificationMenu=function(c){var l,b,x,y=this,w={},A={},n={},g,s,q,p,m,e,o,f=0;l={notificationList:{showMenu:true,anchor:"bubble",offset:"0 24"},bubble:{useColors:true,colors:["#f56c7e","#fec151","#7ad2f4"],showEmptyBubble:true},showNotificationList:true,notificationListEmptyText:"No Notifications",defaultCategory:"general",anchor:"body",relativeImagePath:"notification_menu/images/",createCallback:function(B){},deleteCallback:function(B){},notificationCountIncrease:function(B){},notificationClickCallback:function(B){}};x={tmp:'<div id="tmp"></div>',notification:'<div class="ttw-notification"><span class="icon"></span><span class="message"></span><span class="close"></span></div>',notificationIcon:'<img src="" alt="notification icon"/>',notificationBubble:'<span class="notification-bubble" title="Notifications"></span>'};e={notification:".ttw-notification",notificationList:".notification-list",notificationListItem:".notification-list-item",notificationMessage:".message",notificationClose:".close",notificationListMenuItem:".notification-list-menu-item",notificationListCloseButton:".close-notification-list",notificationIcon:".icon"};p=[];function v(){b=a.extend(true,{},l,c);h(b.defaultCategory)}function h(C,B){p.push(C);w[C]={};w[C].count=0;w[C].readCount=0;w[C].unreadCount=0;w[C].read={};w[C].unread={};if(B&&(C!=b.defaultCategory)){A[C]=B}}function u(C){var B=C.category;if(!w[B]){h(B)}w[B].count++;if(!C.read){w[B].unreadCount++;w[B].unread[C.id]=C}else{w[B].readCount++;w[B].read[C.id]=C}if(t(B,C)){A[B].updateBubble()}}function t(B,C){return(typeof A[B]!="undefined")&&(B!=b.defaultCategory)}function d(C){var B=C.read?"read":"unread";delete w[C.category][B][C.id];delete C}function i(B){return B&&w[B]}function j(B){return(a.inArray(B,["read","unread","all"])!=-1)}function k(B){return((typeof B!="undefined")?B:"")+new Date().getTime()+"-"+Math.floor(Math.random()*(100000-1+1))+1}function r(E,D){if(!D){D="unread"}if(!(i(E)||E=="all")){return false}if(!j(D)){return false}if(E!="all"&&D!="all"){return w[E][D]}else{if(E=="all"&&D=="all"){var F={},C={};for(var B=0;B<p.length;B++){a.extend(C,w[E[B]].read,w[E[B]].unread);a.extend(F,C)}return F}else{if(E=="all"&&D!="all"){var F={};for(var B=0;B<p.length;B++){a.extend(F,w[p[B]][D])}return F}else{if(E!="all"&&D=="all"){return a.extend({},w[E].read,w[E].unread)}else{return false}}}}}function z(C){var B=Array.prototype.slice.call(arguments,1);if(a.isFunction(C)){C.apply(this,B)}}g=function(C,B){this.category=C;this.$item=a(B);this.$bubble={};this.notificationList=false;this.colors=b.bubble.colors;this.init()};g.prototype.init=function(){var B=this;this.createBubble();if(b.showNotificationList){this.$bubble.bind("click",function(){if(!B.notificationList){B.notificationList=new q({category:B.category,$anchor:(b.notificationList.anchor=="bubble")?B.$bubble:B.$item})}})}n[this.category]=0};g.prototype.createBubble=function(){this.$bubble=a(x.notificationBubble).html("0").appendTo(this.$item);if(b.bubble.useColors){if(f>=this.colors.length){f=0}this.$bubble.css("background-color",this.colors[f]);f++}if(b.bubble.showEmptyBubble){this.$bubble.css("display","inline")}};g.prototype.updateBubble=function(){var B=(w[this.category])?w[this.category].unreadCount:0;this.$bubble.html(B);if(B<=0&&!b.bubble.showEmptyBubble){this.$bubble.stop().fadeOut("fast")}if(B>0&&(n[this.category]==0)){this.$bubble.stop().fadeIn()}if(n[this.category]<B){z(b.notificationCountIncrease,this)}n[this.category]=B};q=function(C){this.$wrapper={};this.$list=false;this.type="unread";this.markup={notificationListWrapper:'<div class="notification-list-wrapper"></div>',notificationListMenu:'<ul class="notification-list-menu"><li id="unread-menu-item" class="notification-list-menu-item">Unread</li><li id="all-menu-item" class="notification-list-menu-item">All</li><li class="close-notification-list"></li></ul>',notificationListMenuItem:'<li class="notification-list-menu-item"></li>',notificationList:'<ul class="notification-list"></ul>',notificationListItem:'<li class="notification-list-item"></li>'};this.settings=a.extend(true,{},b.notificationList,C);if(o){var B=this;o.close(function(){B.build()})}else{this.build()}return this};q.prototype.build=function(){var B;this.$wrapper=a(this.markup.notificationListWrapper);if(this.settings.showMenu){B=a(this.markup.notificationListMenu);this.$wrapper.append(B)}this.populate();this.bindMenuActions();this.$wrapper.appendTo(b.anchor).position({my:"center top",at:"center bottom",of:this.settings.$anchor,offset:this.settings.offset});this.$wrapper.css("display","block").animate({opacity:1});o=this};q.prototype.populate=function(){var D,C=this,E,B;D=a(this.markup.notificationList).attr("data-type",C.type);E=r(this.settings.category,this.type);if(!a.isEmptyObject(E)){a.each(E,function(F,G){B=G.settings.icon?"show-icon":"";a(C.markup.notificationListItem).addClass(B).append(G.getHtml()).data({id:G.id,category:G.category,notification:G}).appendTo(D)})}else{a(C.markup.notificationListItem).addClass("empty-list").html(b.notificationListEmptyText).appendTo(D)}D.find(e.notificationListItem).bind("click",function(){z(b.notificationClickCallback,a(this).data("notification"))});if(this.$list){this.$list.remove()}this.$list=D;this.$wrapper.append(this.$list)};q.prototype.bindMenuActions=function(){var C=this,B;this.$wrapper.find(e.notificationListMenuItem).bind("click",function(){C.type=a(this).attr("id").split("-")[0];C.populate()});this.$wrapper.delegate(".close","click",function(){var D=a(this);D.parents(e.notificationListItem).animate({opacity:0},400,function(){var F=a(this),E=F.data();if(w&&w[E.category]&&w[E.category][C.type]){if(w[E.category][C.type][E.id]){B=w[E.category][C.type][E.id].markRead();A[E.category].updateBubble()}}F.remove();z(b.markReadCallback,B)})});this.$wrapper.find(e.notificationListCloseButton).bind("click",function(){C.close()})};q.prototype.close=function(C){var B=this;this.$wrapper.fadeOut(50,function(){B.$wrapper.remove();A[B.settings.category].notificationList=false;o=false;z(C)})};s=function(B){this.id="";this.message={};this.category="";this.$notification=false;this.read=false;if(typeof B=="string"){this.settings=b.notification;this.settings.message=B}else{this.settings=B}};s.prototype.create=function(){if(this.settings.message){this.id=this.settings.id||k("notification");this.message=this.settings.message;this.category=this.settings.category?this.settings.category:b.defaultCategory;this.read=(typeof this.settings.read!="undefined")?this.settings.read:this.read;return this}else{return false}};s.prototype.html=function(){this.$notification=a(x.notification);if(!this.settings.icon){this.$notification.find(e.notificationIcon).remove()}this.$notification.attr("id",this.id);if(this.settings.notificationClass){this.$notification.addClass(this.settings.notificationClass)}this.setValues()};s.prototype.getHtml=function(){if(!this.$notification){this.html()}return this.$notification.clone()};s.prototype.setValues=function(){if(typeof this.settings.icon!="undefined"){this.$notification.addClass("show-icon").find(".icon").css("background","transparent url("+this.settings.icon+") no-repeat center center scroll").html(x.notificationIcon).find("img").attr("src",this.settings.icon)}if(typeof this.message!="undefined"){this.$notification.find(".message").html(this.message)}};s.prototype.markRead=function(){this.read=true;w[this.category].readCount++;w[this.category].read[this.id]=this;w[this.category].unreadCount--;delete w[this.category].unread[this.id];return this};s.prototype.destroy=function(){d(this)};y.createNotification=function(C){var B=new s(C);if(B.create()){u(B);z(b.createCallback,B)}return B};y.initMenu=function(B){a.each(B,function(E,C){var D=new g(E,C);h(E,D)})};y.getNotifications=function(C,B){return r(C,B)};y.deleteNotification=function(B){B.destroy()};y.notifications=w;v();return y}})(jQuery);